<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BluedonuLab - ì„±í–¥ê¸°ë°˜ ê°„ë³‘ì¸ ë§¤ì¹­ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50">

<!-- Navigation -->
<nav class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-blue-600">ğŸ¥ BluedonuLab</h1>
        <div class="flex gap-4">
            <button onclick="loadPage('welcome')" class="px-4 py-2 rounded hover:bg-gray-100">í™ˆ</button>
            <button onclick="loadPage('test')" class="px-4 py-2 rounded hover:bg-gray-100">ì„±í–¥í…ŒìŠ¤íŠ¸</button>
            <button onclick="loadPage('recommendations')" class="px-4 py-2 rounded hover:bg-gray-100">ê°„ë³‘ì¸ ì¶”ì²œ</button>
            <button onclick="loadPage('dashboard')" class="px-4 py-2 rounded hover:bg-gray-100">ë§¤ì¹­í˜„í™©</button>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div id="mainContent" class="max-w-6xl mx-auto px-4 py-8">
    <!-- Welcome Page -->
    <div id="welcomePage" class="page-content">
        <div class="gradient-bg text-white rounded-lg p-12 mb-8">
            <h2 class="text-4xl font-bold mb-4">BluedonuLabì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</h2>
            <p class="text-xl mb-8">AI ê¸°ë°˜ ì„±í–¥ ë¶„ì„ìœ¼ë¡œ ìµœì ì˜ ê°„ë³‘ì¸ì„ ì°¾ì•„ë“œë¦½ë‹ˆë‹¤</p>
            <button onclick="loadPage('test')" class="bg-white text-blue-600 px-8 py-3 rounded-lg font-bold hover:bg-gray-100 text-lg">
                ì‹œì‘í•˜ê¸° â†’
            </button>
        </div>

        <div class="grid grid-cols-3 gap-6">
            <div class="card-hover bg-white p-6 rounded-lg shadow">
                <div class="text-3xl mb-3">ğŸ“Š</div>
                <h3 class="text-xl font-bold mb-2">1000+ ê°„ë³‘ì¸</h3>
                <p class="text-gray-600">ê²€ì¦ëœ ì „ë¬¸ ê°„ë³‘ì¸ í’€</p>
            </div>
            <div class="card-hover bg-white p-6 rounded-lg shadow">
                <div class="text-3xl mb-3">ğŸ¯</div>
                <h3 class="text-xl font-bold mb-2">ì„±í–¥ ë§¤ì¹­</h3>
                <p class="text-gray-600">ì„±ê²©ê³¼ ì„ í˜¸ë„ ê¸°ë°˜ ì¶”ì²œ</p>
            </div>
            <div class="card-hover bg-white p-6 rounded-lg shadow">
                <div class="text-3xl mb-3">âš¡</div>
                <h3 class="text-xl font-bold mb-2">ë¹ ë¥¸ ë§¤ì¹­</h3>
                <p class="text-gray-600">24ì‹œê°„ ë‚´ ê°„ë³‘ì¸ ë°°ì¹˜</p>
            </div>
        </div>

        <!-- System Status -->
        <div class="mt-8 bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-bold mb-4">ğŸ“ˆ ì‹œìŠ¤í…œ ìƒíƒœ</h3>
            <div id="systemStatus" class="grid grid-cols-2 gap-4">
                <div class="p-4 bg-gray-50 rounded">
                    <p class="text-gray-600">API ìƒíƒœ</p>
                    <p id="apiStatusText" class="text-xl font-bold">í™•ì¸ ì¤‘...</p>
                </div>
                <div class="p-4 bg-gray-50 rounded">
                    <p class="text-gray-600">ë°ì´í„°ë² ì´ìŠ¤</p>
                    <p id="dbStatusText" class="text-xl font-bold">í™•ì¸ ì¤‘...</p>
                </div>
                <div class="p-4 bg-gray-50 rounded">
                    <p class="text-gray-600">ë“±ë¡ëœ í™˜ì</p>
                    <p id="patientCountText" class="text-xl font-bold">-</p>
                </div>
                <div class="p-4 bg-gray-50 rounded">
                    <p class="text-gray-600">ì„±í–¥í…ŒìŠ¤íŠ¸ ì™„ë£Œìœ¨</p>
                    <p id="completionRateText" class="text-xl font-bold">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Personality Test Page -->
    <div id="testPage" class="page-content hidden">
        <div class="bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold mb-2">ì„±í–¥ í…ŒìŠ¤íŠ¸</h2>
            <p class="text-gray-600 mb-8">ë‹¹ì‹ ì˜ ì„±í–¥ì„ íŒŒì•…í•˜ì—¬ ìµœì ì˜ ê°„ë³‘ì¸ì„ ì°¾ì•„ë“œë¦½ë‹ˆë‹¤</p>

            <!-- Progress Bar -->
            <div class="mb-8">
                <div class="flex justify-between mb-2">
                    <span id="questionNum" class="font-bold">ì§ˆë¬¸ 1/12</span>
                    <span id="progressPercent" class="text-gray-600">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                </div>
            </div>

            <!-- Questions -->
            <div id="questionContainer">
                <!-- Questions will be loaded here -->
            </div>

            <!-- Test Result Summary -->
            <div id="testResultSummary" class="hidden mt-8 p-6 bg-green-50 border-2 border-green-300 rounded-lg">
                <h3 class="text-xl font-bold mb-4 text-green-700">âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ!</h3>
                <p id="resultMessage" class="text-gray-700 mb-4"></p>
                <button onclick="loadPage('recommendations')" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">
                    ê°„ë³‘ì¸ ì¶”ì²œ ë³´ê¸° â†’
                </button>
            </div>
        </div>
    </div>

    <!-- Caregiver Recommendations Page -->
    <div id="recommendationsPage" class="page-content hidden">
        <div class="bg-white p-8 rounded-lg shadow-lg mb-8">
            <h2 class="text-3xl font-bold mb-2">ë§ì¶¤ ê°„ë³‘ì¸ ì¶”ì²œ</h2>
            <p class="text-gray-600 mb-6">ë‹¹ì‹ ì„ ìœ„í•´ ì—„ì„ ëœ ê°„ë³‘ì¸ë“¤ì…ë‹ˆë‹¤</p>

            <!-- Filters -->
            <div class="flex gap-4 mb-8">
                <select id="gradeFilter" onchange="filterRecommendations()" class="px-4 py-2 border rounded">
                    <option value="">ëª¨ë“  ë“±ê¸‰</option>
                    <option value="A">A ë“±ê¸‰</option>
                    <option value="B">B ë“±ê¸‰</option>
                    <option value="C">C ë“±ê¸‰</option>
                </select>
                <input type="number" id="minScoreFilter" placeholder="ìµœì†Œ ì ìˆ˜" min="0" max="100"
                       onchange="filterRecommendations()" class="px-4 py-2 border rounded w-32">
            </div>

            <!-- Recommendations List -->
            <div id="recommendationsList" class="space-y-6">
                <div class="text-center text-gray-600 py-8">ê°„ë³‘ì¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="page-content hidden">
        <div class="bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold mb-2">ë§¤ì¹­ í˜„í™©</h2>
            <p class="text-gray-600 mb-8">í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë§¤ì¹­</p>

            <!-- Active Matchings -->
            <div id="matchingList" class="space-y-4">
                <div class="text-center text-gray-600 py-8">ë§¤ì¹­ í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>

            <!-- Matching History -->
            <div class="mt-12">
                <h3 class="text-2xl font-bold mb-6">ë§¤ì¹­ ì´ë ¥</h3>
                <div id="matchingHistory" class="space-y-4">
                    <div class="text-center text-gray-600 py-8">ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- API Client -->
<script src="api-client.js"></script>

<!-- Main App Script -->
<script>
const PATIENT_ID = 1;
const QUESTIONS = [
    { question: "í˜¼ì ìˆì„ ë•Œ í¸ì•ˆí•¨ì„ ëŠë¼ì‹œë‚˜ìš”?", options: ["ë§¤ìš° ê·¸ë ‡ë‹¤", "ë³´í†µì´ë‹¤", "ê·¸ë ‡ì§€ ì•Šë‹¤"] },
    { question: "ìƒˆë¡œìš´ ì‚¬ëŒì„ ë§Œë‚˜ëŠ” ê²ƒì„ ì¢‹ì•„í•˜ì‹œë‚˜ìš”?", options: ["ë§¤ìš° ì¢‹ì•„í•œë‹¤", "ë³´í†µì´ë‹¤", "ì¢‹ì•„í•˜ì§€ ì•ŠëŠ”ë‹¤"] },
    { question: "ì •í•´ì§„ ì¼ì •ëŒ€ë¡œ ìƒí™œí•˜ëŠ” ê²ƒì„ ì„ í˜¸í•˜ì‹œë‚˜ìš”?", options: ["ë§¤ìš° ì„ í˜¸í•œë‹¤", "ë³´í†µì´ë‹¤", "ì„ í˜¸í•˜ì§€ ì•ŠëŠ”ë‹¤"] },
    { question: "íƒ€ì¸ì˜ ê°ì •ì„ ì˜ ì´í•´í•˜ëŠ” í¸ì¸ê°€ìš”?", options: ["ë§¤ìš° ê·¸ë ‡ë‹¤", "ë³´í†µì´ë‹¤", "ê·¸ë ‡ì§€ ì•Šë‹¤"] },
    { question: "í™œë™ì ì¸ ì·¨ë¯¸ë¥¼ ì¦ê¸°ì‹œë‚˜ìš”?", options: ["ë§¤ìš° ì¦ê¸´ë‹¤", "ë³´í†µì´ë‹¤", "ì¦ê¸°ì§€ ì•ŠëŠ”ë‹¤"] },
    { question: "ì¸ë‚´ì‹¬ì´ ìˆëŠ” í¸ì¸ê°€ìš”?", options: ["ë§¤ìš° ê·¸ë ‡ë‹¤", "ë³´í†µì´ë‹¤", "ê·¸ë ‡ì§€ ì•Šë‹¤"] },
    { question: "í˜¼ì ê²°ì •í•˜ëŠ” ê²ƒì„ ì„ í˜¸í•˜ì‹œë‚˜ìš”?", options: ["ë§¤ìš° ì„ í˜¸í•œë‹¤", "ë³´í†µì´ë‹¤", "ì„ í˜¸í•˜ì§€ ì•ŠëŠ”ë‹¤"] },
    { question: "ë‹¤ë¥¸ ì‚¬ëŒì˜ ë„ì›€ì„ ì‰½ê²Œ ë°›ì•„ë“¤ì´ì‹œë‚˜ìš”?", options: ["ë§¤ìš° ê·¸ë ‡ë‹¤", "ë³´í†µì´ë‹¤", "ê·¸ë ‡ì§€ ì•Šë‹¤"] },
    { question: "ê·œì¹™ì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ì‹œë‚˜ìš”?", options: ["ë§¤ìš° ì¤‘ìš”í•˜ë‹¤", "ë³´í†µì´ë‹¤", "ì¤‘ìš”í•˜ì§€ ì•Šë‹¤"] },
    { question: "ë³€í™”ì— ì˜ ì ì‘í•˜ì‹œë‚˜ìš”?", options: ["ë§¤ìš° ì˜í•œë‹¤", "ë³´í†µì´ë‹¤", "ì˜í•˜ì§€ ëª»í•œë‹¤"] },
    { question: "ì¡°ìš©í•œ í™˜ê²½ì„ ì„ í˜¸í•˜ì‹œë‚˜ìš”?", options: ["ë§¤ìš° ì„ í˜¸í•œë‹¤", "ë³´í†µì´ë‹¤", "ì„ í˜¸í•˜ì§€ ì•ŠëŠ”ë‹¤"] },
    { question: "íƒ€ì¸ê³¼ì˜ ìƒí˜¸ì‘ìš©ì„ ì¦ê¸°ì‹œë‚˜ìš”?", options: ["ë§¤ìš° ì¦ê¸´ë‹¤", "ë³´í†µì´ë‹¤", "ì¦ê¸°ì§€ ì•ŠëŠ”ë‹¤"] }
];

let currentQuestion = 0;
let testAnswers = [];

// Initialize on page load
document.addEventListener('DOMContentLoaded', async function() {
    await checkSystemStatus();
    loadPage('welcome');
});

// Check system status
async function checkSystemStatus() {
    try {
        const status = await api.getAPIStatus();
        document.getElementById('apiStatusText').textContent = 'âœ… ìš´ì˜ ì¤‘';
        document.getElementById('apiStatusText').className = 'text-xl font-bold text-green-600';
        document.getElementById('dbStatusText').textContent = 'âœ… ì—°ê²°ë¨';
        document.getElementById('dbStatusText').className = 'text-xl font-bold text-green-600';

        const stats = await api.getPersonalityStats();
        document.getElementById('patientCountText').textContent = stats.total_count.toLocaleString() + 'ëª…';
        document.getElementById('completionRateText').textContent = stats.completion_rate.toFixed(1) + '%';
    } catch (error) {
        console.error('Status check failed:', error);
        document.getElementById('apiStatusText').textContent = 'âŒ ì—°ê²° ì‹¤íŒ¨';
        document.getElementById('apiStatusText').className = 'text-xl font-bold text-red-600';
    }
}

// Page Navigation
function loadPage(pageName) {
    // Hide all pages
    document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));

    // Show selected page
    const pageId = pageName + 'Page';
    const page = document.getElementById(pageId);
    if (page) {
        page.classList.remove('hidden');

        // Load page-specific data
        if (pageName === 'test') {
            currentQuestion = 0;
            testAnswers = [];
            showQuestion();
        } else if (pageName === 'recommendations') {
            loadRecommendations();
        } else if (pageName === 'dashboard') {
            loadDashboard();
        }
    }
}

// === Personality Test ===
function showQuestion() {
    if (currentQuestion >= QUESTIONS.length) {
        submitTest();
        return;
    }

    const q = QUESTIONS[currentQuestion];
    document.getElementById('questionNum').textContent = `ì§ˆë¬¸ ${currentQuestion + 1}/${QUESTIONS.length}`;
    document.getElementById('progressPercent').textContent = `${Math.round((currentQuestion / QUESTIONS.length) * 100)}%`;
    document.getElementById('progressBar').style.width = `${(currentQuestion / QUESTIONS.length) * 100}%`;

    let html = `<div class="mb-8">
        <h3 class="text-2xl font-bold mb-6">${q.question}</h3>
        <div class="space-y-3">`;

    q.options.forEach((option, idx) => {
        html += `<label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-400 transition">
            <input type="radio" name="answer" value="${idx}" class="mr-4 w-5 h-5">
            <span class="text-lg">${option}</span>
        </label>`;
    });

    html += `</div></div>`;
    html += `<div class="flex gap-4">
        <button onclick="prevQuestion()" class="px-6 py-2 border rounded font-bold hover:bg-gray-100" ${currentQuestion === 0 ? 'disabled style="opacity:0.5"' : ''}>â† ì´ì „</button>
        <button onclick="nextQuestion()" class="flex-1 px-6 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">ë‹¤ìŒ â†’</button>
    </div>`;

    document.getElementById('questionContainer').innerHTML = html;
}

function prevQuestion() {
    if (currentQuestion > 0) {
        currentQuestion--;
        showQuestion();
    }
}

function nextQuestion() {
    const selected = document.querySelector('input[name="answer"]:checked');
    if (!selected) {
        alert('ë‹µì„ ì„ íƒí•´ì£¼ì„¸ìš”');
        return;
    }

    testAnswers[currentQuestion] = parseInt(selected.value);
    currentQuestion++;
    showQuestion();
}

async function submitTest() {
    try {
        const result = await api.savePersonalityTest(PATIENT_ID, testAnswers);
        document.getElementById('questionContainer').innerHTML = '';
        document.getElementById('testResultSummary').classList.remove('hidden');
        document.getElementById('resultMessage').textContent =
            `ë‹¹ì‹ ì˜ ì„±í–¥ í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ë§ì¶¤ ê°„ë³‘ì¸ì„ ì¶”ì²œë°›ìœ¼ì„¸ìš”.`;
    } catch (error) {
        alert('í…ŒìŠ¤íŠ¸ ì œì¶œ ì‹¤íŒ¨: ' + error.message);
    }
}

// === Caregiver Recommendations ===
async function loadRecommendations() {
    try {
        const data = await api.recommendCaregivers(PATIENT_ID, 10);
        let html = '';

        data.recommendations.forEach((caregiver, idx) => {
            const gradeColor = caregiver.grade === 'A' ? 'bg-green-100 text-green-800' :
                              caregiver.grade === 'B' ? 'bg-blue-100 text-blue-800' :
                              'bg-yellow-100 text-yellow-800';

            html += `
            <div class="border rounded-lg p-6 hover:shadow-lg transition">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-bold">${caregiver.caregiver_name}</h3>
                        <p class="text-gray-600">${caregiver.job_title}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-bold text-blue-600">${caregiver.matching_score.toFixed(1)}</div>
                        <span class="px-3 py-1 rounded text-sm font-bold ${gradeColor}">${caregiver.grade}</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="p-3 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">ê³µê°ë„</p>
                        <p class="text-lg font-bold">${caregiver.empathy_match.toFixed(0)}ì </p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">ì˜ë£Œê¸°ìˆ </p>
                        <p class="text-lg font-bold">${caregiver.care_compatibility.toFixed(0)}ì </p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">ì„±ê²©ì¼ì¹˜</p>
                        <p class="text-lg font-bold">${caregiver.personality_compatibility.toFixed(0)}ì </p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">ì¸ë‚´ì‹¬</p>
                        <p class="text-lg font-bold">${caregiver.patience_match.toFixed(0)}ì </p>
                    </div>
                </div>

                <button onclick="requestMatching(${caregiver.caregiver_id}, '${caregiver.caregiver_name}')"
                        class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">
                    ë§¤ì¹­ ìš”ì²­
                </button>
            </div>`;
        });

        document.getElementById('recommendationsList').innerHTML = html || '<p class="text-center text-gray-600">ì¶”ì²œ ê°„ë³‘ì¸ì´ ì—†ìŠµë‹ˆë‹¤</p>';
    } catch (error) {
        console.error('Failed to load recommendations:', error);
        document.getElementById('recommendationsList').innerHTML = `<p class="text-center text-red-600">ì˜¤ë¥˜: ${error.message}</p>`;
    }
}

async function requestMatching(caregiverId, caregiverName) {
    try {
        const result = await api.createMatching(PATIENT_ID, caregiverId);
        alert(`âœ… ${caregiverName}ë‹˜ê³¼ì˜ ë§¤ì¹­ ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`);
        loadDashboard();
    } catch (error) {
        alert(`âŒ ë§¤ì¹­ ìš”ì²­ ì‹¤íŒ¨: ${error.message}`);
    }
}

function filterRecommendations() {
    // TODO: Implement filtering
    loadRecommendations();
}

// === Dashboard ===
async function loadDashboard() {
    try {
        const history = await api.getMatchingHistory(PATIENT_ID);
        let html = '';

        if (history.matchings && history.matchings.length > 0) {
            history.matchings.forEach(matching => {
                html += `
                <div class="border rounded-lg p-6 ${matching.status === 'Active' ? 'border-green-300 bg-green-50' : 'border-gray-300'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-bold">${matching.caregiver_name}</h3>
                            <p class="text-gray-600">${matching.started_at ? 'ì‹œì‘: ' + new Date(matching.started_at).toLocaleDateString('ko-KR') : ''}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-blue-600">${matching.matching_score.toFixed(1)}</div>
                            <span class="px-3 py-1 rounded text-sm font-bold ${
                                matching.status === 'Active' ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-800'
                            }">${matching.status}</span>
                        </div>
                    </div>
                </div>`;
            });
        } else {
            html = '<p class="text-center text-gray-600">í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë§¤ì¹­ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        }

        document.getElementById('matchingHistory').innerHTML = html;
    } catch (error) {
        console.error('Failed to load dashboard:', error);
        document.getElementById('matchingHistory').innerHTML = `<p class="text-center text-red-600">ì˜¤ë¥˜: ${error.message}</p>`;
    }
}
</script>

</body>
</html>
