name: Deploy Backend to Azure App Service

on:
  push:
    branches:
      - main
      - backend-deploy  # ë°±ì—”ë“œ ì „ìš© ë¸Œëœì¹˜ ì¶”ê°€
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: 'neulbomcare'  # Azure App Service ì´ë¦„
  PYTHON_VERSION: '3.12'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: ğŸ›ï¸ Checkout code
      uses: actions/checkout@v4

    # 2. Python ì„¤ì •
    - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # 3. ìºì‹œ ì„¤ì • (ë¹Œë“œ ì†ë„ í–¥ìƒ)
    - name: ğŸ“¦ Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # 4. ì˜ì¡´ì„± ì„¤ì¹˜ ë° ê²€ì¦
    - name: ğŸ“¥ Install dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… Dependencies installed successfully"

    # 5. ì˜ì¡´ì„± ê²€ì¦ (uvicorn, gunicorn í™•ì¸)
    - name: âœ… Verify critical packages
      working-directory: ./backend
      run: |
        python -c "import uvicorn; print('âœ… uvicorn:', uvicorn.__version__)"
        python -c "import gunicorn; print('âœ… gunicorn:', gunicorn.__version__)"
        python -c "import fastapi; print('âœ… fastapi:', fastapi.__version__)"
        python -c "import sqlalchemy; print('âœ… sqlalchemy:', sqlalchemy.__version__)"

    # 6. ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (ì„ íƒì‚¬í•­)
    - name: ğŸ” Lint with flake8
      working-directory: ./backend
      run: |
        pip install flake8
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=.venv,venv
      continue-on-error: true

    # 7. ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± (Oryx ë¹Œë“œìš©)
    - name: ğŸ“¦ Create deployment package
      working-directory: ./backend
      run: |
        echo "ğŸ“‹ Files to be deployed:"
        ls -lah

        # ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œì™¸í•˜ê³  ì••ì¶•
        zip -r ../backend-deploy.zip . \
          -x "*.pyc" -x "__pycache__/*" -x ".venv/*" -x "venv/*" \
          -x ".git/*" -x ".env" -x "*.log"

        cd ..
        echo "âœ… Deployment package created:"
        ls -lh backend-deploy.zip

    # 8. Azure App Service ë°°í¬
    - name: ğŸš€ Deploy to Azure Web App
      id: deploy-to-webapp
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        package: './backend-deploy.zip'
        publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_6E1F31532FB1401E8E2AD1CE74DD597F }}
        # startup-commandëŠ” Azure Portalì—ì„œ ì„¤ì • (startup.sh ì‚¬ìš©)

    # 9. ë°°í¬ í›„ ì›Œë°ì—… (Cold Start ë°©ì§€)
    - name: ğŸ”¥ Warm up application
      run: |
        echo "â³ Waiting for deployment to complete..."
        sleep 30
        echo "ğŸ”¥ Warming up application..."
        curl -f https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/ || echo "âš ï¸  Root endpoint not responding"

    # 10. Health Check
    - name: ğŸ¥ Health check
      run: |
        echo "ğŸ¥ Checking health endpoint..."
        for i in {1..5}; do
          if curl -f https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health; then
            echo "âœ… Health check passed!"
            exit 0
          fi
          echo "â³ Attempt $i failed, retrying in 10s..."
          sleep 10
        done
        echo "âŒ Health check failed after 5 attempts"
        exit 1

    # 11. ë°°í¬ ì™„ë£Œ ì•Œë¦¼
    - name: âœ… Deployment Success
      if: success()
      run: |
        echo "========================================"
        echo "âœ… Backend successfully deployed!"
        echo "========================================"
        echo "ğŸŒ URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        echo "ğŸ“š Docs: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/docs"

    - name: âŒ Deployment Failed
      if: failure()
      run: |
        echo "========================================"
        echo "âŒ Backend deployment failed"
        echo "========================================"
        echo "Please check the logs above for details"
